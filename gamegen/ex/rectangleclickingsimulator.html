<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@<version>/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@<version>/examples/jsm/"
  }
}
</script>
</head>
<body>
<script type="module">
/*
Rectangle Clicking Simulator
Minimal, optimized, full game in a single module
*/
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';

/* ---------- CONFIG ---------- */
const CFG = {
  res      : () => Math.min(window.innerWidth, window.innerHeight),
  rectTTL  : 1800,
  rectCap  : 40,
  points   : 0,
  combo    : 0,
  comboMax : 0,
  cps      : 0,
  clickLog : 0,
  autoTick : 700
};
let scene, camera, renderer, rects = [], drones = [], powerSlow = 1;
const ray  = new THREE.Raycaster();
const mp   = new THREE.Vector2();
const TAU  = Math.PI * 2;
const clock = new THREE.Clock();

/* ---------- THREE ---------- */
function init3D() {
  scene = new THREE.Scene();
  camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 10);
  renderer = new THREE.WebGLRenderer({ alpha: true });
  renderer.setSize(CFG.res(), CFG.res());
  document.body.appendChild(renderer.domElement);
}

/* ---------- UI ---------- */
function buildUI() {
  const panel = document.createElement('div');
  panel.id = 'ui';
  panel.style.cssText = `
    position:fixed; inset:0;font-family:sans-serif;color:#fff;
    pointer-events:none;user-select:none;`;
  panel.innerHTML = `
    <div style="position:absolute;top:10px;left:10px;font-size:20px;">
      <span id="points">0</span> pts
      <div style="font-size:14px;">Combo: <span id="combo">0</span> / Max: <span id="cmax">0</span></div>
      <div style="font-size:14px;">CPS: <span id="cps">0</span></div>
    </div>

    <div style="position:absolute;top:10px;right:10px;font-size:14px;">
      <button onclick="buy(1)" style="pointer-events:auto;margin:2px;cursor:pointer;">
        +Size (50)
      </button><br>
      <button onclick="buy(2)" style="pointer-events:auto;margin:2px;cursor:pointer;">
        +Drone (300)
      </button><br>
      <button onclick="buy(3)" style="pointer-events:auto;margin:2px;cursor:pointer;">
        +SlowMo (1000)
      </button><br>
    </div>

    <div id="slowmsg" style="position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:none;">
      SLOW-MO ACTIVE!
    </div>
  `;
  document.body.appendChild(panel);
  window.buy = buy;            // inline onclick needs globals under modules
}

/* ---------- RECT LOGIC ---------- */
class Rect {
  constructor(x, y, w, h, c, o, life) {
    this.life = life || CFG.rectTTL;
    const g = new THREE.PlaneGeometry(w, h);
    const m = new THREE.MeshBasicMaterial({ color: c, transparent: true, opacity: o });
    this.mesh = new THREE.Mesh(g, m);
    this.mesh.position.set(x, y, 0);
    scene.add(this.mesh);
  }
  tick(dt) {
    this.life -= dt * powerSlow;
    if (this.life < 200) {
      this.mesh.material.opacity *= 0.9;
    }
  }
  kill() {
    scene.remove(this.mesh);
  }
}

function spawnRect(split) {
  if (rects.length >= CFG.rectCap) return;
  const w = split ? Math.random() * 0.1 : Math.random() * 0.3;
  const h = split ? Math.random() * 0.1 : Math.random() * 0.3;
  const x = (Math.random() - 0.5) * (1 - w * 2);
  const y = (Math.random() - 0.5) * (1 - h * 2);
  const c = new THREE.Color(Math.random(), Math.random(), Math.random());
  const o = Math.random() * 0.5 + 0.5;
  const life = split ? CFG.rectTTL * 0.4 : CFG.rectTTL;
  rects.push(new Rect(x, y, w, h, c, o, life));
}

/* ---------- FRENETIC SPAWNER ---------- */
setInterval(() => {
  if (Math.random() < 0.8) spawnRect();
}, 1000);

/* ---------- HIT TEST ---------- */
function pointer(x, y) {
  mp.x = (x / renderer.domElement.width) * 2 - 1;
  mp.y = -(y / renderer.domElement.height) * 2 + 1;
}
document.addEventListener('click', ev => {
  pointer(ev.clientX, ev.clientY);
  ray.setFromCamera(mp, camera);
  const hits = ray.intersectObjects(scene.children);
  if (hits.length === 0) { gain(0); return; }
  const idx = rects.findIndex(r => r.mesh === hits[0].object);
  if (idx === -1) return;
  const R = rects[idx];
  // explode
  for (let k = 0; k < 3; k++) spawnRect(true);
  gain(10 * (1 + CFG.combo * 0.1));
  R.kill();
  rects.splice(idx, 1);
});

/* ---------- IDLE DRONES ---------- */
class Drone {
  constructor() {
    const g = new THREE.CircleGeometry(0.02, 8);
    const m = new THREE.MeshBasicMaterial({ color: 0x00ffff });
    this.mesh = new THREE.Mesh(g, m);
    scene.add(this.mesh);
    this.t = 0;
  }
  tick(dt) {
    this.t += dt;
    this.mesh.position.x = Math.cos(this.t * 0.7) * 0.9;
    this.mesh.position.y = Math.sin(this.t * 0.5) * 0.9;
    // suck nearby rects
    const near = rects.filter(r =>
      r.mesh.position.distanceTo(this.mesh.position) < 0.2
    );
    near.forEach(r => {
      const idx = rects.indexOf(r);
      gain(5);
      for (let k = 0; k < 3; k++) spawnRect(true);
      r.kill();
      rects.splice(idx, 1);
    });
  }
}

/* ---------- UPGRADE SHOP ---------- */
function buy(id) {
  switch (id) {
    case 1:
      if (CFG.points < 50) return;
      CFG.points -= 50;
      camera.zoom *= 0.9;
      camera.updateProjectionMatrix();
      break;
    case 2:
      if (CFG.points < 300) return;
      CFG.points -= 300;
      drones.push(new Drone());
      break;
    case 3:
      if (CFG.points < 1000) return;
      CFG.points -= 1000;
      powerSlow = 0.25;
      document.getElementById('slowmsg').style.display = 'block';
      setTimeout(() => { powerSlow = 1;
                         document.getElementById('slowmsg').style.display = 'none'; }, 5000);
  }
  syncUI();
}

/* ---------- SCORING ---------- */
function gain(pts) {
  CFG.points += pts;
  CFG.combo++;
  CFG.comboMax = Math.max(CFG.comboMax, CFG.combo);
  CFG.clickLog++;
  setTimeout(() => CFG.combo--, 2000);
  syncUI();
}

setInterval(() => {
  CFG.cps = CFG.clickLog;
  CFG.clickLog = 0;
  document.getElementById('cps').textContent = CFG.cps;
}, 1000);

function syncUI() {
  document.getElementById('points').textContent = CFG.points | 0;
  document.getElementById('combo').textContent = CFG.combo;
  document.getElementById('cmax').textContent = CFG.comboMax;
}

/* ---------- RESIZE ---------- */
window.addEventListener('resize', () => {
  const s = CFG.res();
  renderer.setSize(s, s);
});

/* ---------- MAIN ---------- */
init3D();
buildUI();
syncUI();
animate();

function animate() {
  requestAnimationFrame(animate);
  const dt = clock.getDelta() * 1000;
  rects.forEach((r, i) => {
    r.tick(dt);
    if (r.life <= 0) {
      r.kill();
      rects.splice(i, 1);
    }
  });
  drones.forEach(d => d.tick(dt));
  renderer.render(scene, camera);
}
</script></body></html>